/*
 * This test ensures the integrity of the compiled OpenVPN plugin,
 * by attempting to dlopen the plugin, and checking for the
 * required symbols needed for a OpenVPN plugin.
 */
#include <dlfcn.h>
#include <stdio.h>
#include <stdlib.h>

int main(int argc, const char *argv[])
{
    if (argc != 2) {
	printf("Usage: ./dlopentest <path_to_openvpn_plugin>\n");
	exit(1);
    }

    void *libhandle = dlopen(argv[1], RTLD_NOW);
    if (libhandle == NULL) {
	printf("%s\n", dlerror());
	exit(1);
    }
    void *sym = dlsym(libhandle, "openvpn_plugin_open_v3");
    if (sym == NULL) {
	printf("%s\n", dlerror());
	exit(1);
    }
    sym = dlsym(libhandle, "openvpn_plugin_func_v3");
    if (sym == NULL) {
	printf("%s\n", dlerror());
	exit(1);
    }
    dlclose(libhandle);

    return EXIT_SUCCESS;
}
